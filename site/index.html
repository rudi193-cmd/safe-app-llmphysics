<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JAC Self-Audit Judge — r/LLMPhysics</title>
  <style>
    :root {
      --bg: #f9f9f7;
      --fg: #1c1c1a;
      --fg-muted: #6b6b64;
      --accent: #2d6a4f;
      --accent-light: #e8f4ee;
      --border: #e2e2de;
      --max: 680px;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      font-size: 16px;
      line-height: 1.75;
      margin: 0;
      padding: 0 1rem;
    }
    .container { max-width: var(--max); margin: 0 auto; }
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 2.5rem;
    }
    .nav-brand { font-weight: 700; font-size: 15px; color: var(--accent); text-decoration: none; letter-spacing: 0.04em; }
    .nav-link { font-size: 14px; color: var(--fg-muted); text-decoration: none; }
    .nav-link:hover { color: var(--accent); }
    .eyebrow { font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--accent); margin-bottom: 0.5rem; }
    .hero { margin-bottom: 2.5rem; }
    .hero h1 { font-size: 1.75rem; font-weight: 700; color: var(--fg); margin: 0 0 0.6rem; line-height: 1.3; }
    .hero .subline { font-size: 15px; color: var(--fg-muted); margin-bottom: 0.4rem; }
    .hero .note { font-size: 13px; color: var(--fg-muted); }
    .api-section { margin-bottom: 1.5rem; }
    .api-chip { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 13px; background: var(--accent-light); color: var(--accent); border: 1px solid #b7d9c8; border-radius: 20px; padding: 0.25rem 0.75rem; }
    .api-chip a { color: var(--fg-muted); font-size: 12px; margin-left: 0.25rem; cursor: pointer; text-decoration: underline; }
    .api-form { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: flex-end; }
    .api-form select, .api-form input[type="text"], .api-form input[type="password"] { font-size: 13px; border: 1px solid var(--border); border-radius: 4px; padding: 0.4rem 0.6rem; background: #fff; color: var(--fg); outline: none; }
    .api-form select:focus, .api-form input:focus { border-color: var(--accent); }
    .btn-sm { font-size: 13px; padding: 0.4rem 0.9rem; border: none; border-radius: 4px; background: var(--accent); color: #fff; cursor: pointer; font-weight: 600; }
    .btn-sm:hover { opacity: 0.88; }
    .section-label { font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--fg-muted); margin-bottom: 0.4rem; }
    textarea#paperInput { width: 100%; min-height: 300px; resize: vertical; font-size: 14px; font-family: inherit; line-height: 1.6; border: 1px solid var(--border); border-radius: 4px; padding: 0.75rem 1rem; background: #fff; color: var(--fg); outline: none; }
    textarea#paperInput:focus { border-color: var(--accent); }
    .char-count { font-size: 12px; color: var(--fg-muted); text-align: right; margin-top: 0.2rem; }
    .url-row { margin-top: 0.75rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .url-row > label { font-size: 13px; color: var(--fg-muted); white-space: nowrap; }
    .url-row input[type="text"] { font-size: 13px; flex: 1; min-width: 160px; border: 1px solid var(--border); border-radius: 4px; padding: 0.35rem 0.6rem; background: #fff; color: var(--fg); outline: none; }
    .url-row input[type="text"]:focus { border-color: var(--accent); }
    .url-fetch-btn { font-size: 13px; padding: 0.35rem 0.8rem; border: none; border-radius: 4px; background: var(--accent); color: #fff; cursor: pointer; font-weight: 600; white-space: nowrap; }
    .url-fetch-btn:hover:not(:disabled) { opacity: 0.88; }
    .url-fetch-btn:disabled { opacity: 0.45; cursor: not-allowed; }
    .url-browse-btn { font-size: 13px; padding: 0.35rem 0.8rem; border: 1px solid var(--border); border-radius: 4px; background: #fff; color: var(--fg-muted); cursor: pointer; font-weight: 600; white-space: nowrap; }
    .url-browse-btn:hover { border-color: var(--accent); color: var(--accent); }
    .url-row .divider { font-size: 12px; color: var(--fg-muted); }
    .url-status { font-size: 12px; font-style: italic; width: 100%; padding-left: 0; }
    .rubric-toggle { display: flex; align-items: center; gap: 0.4rem; font-size: 13px; color: var(--fg-muted); cursor: pointer; user-select: none; margin: 1rem 0 0; background: none; border: none; padding: 0; }
    .rubric-toggle:hover { color: var(--accent); }
    #rubricBody { display: none; margin-top: 0.75rem; }
    #rubricBody.open { display: block; }
    .rubric-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .rubric-table th, .rubric-table td { border: 1px solid var(--border); padding: 0.4rem 0.75rem; text-align: left; }
    .rubric-table th { background: var(--accent-light); font-weight: 600; font-size: 12px; }
    .rubric-table tr:last-child td { font-weight: 700; }
    .score-wrap { margin: 1.5rem 0; }
    #scoreBtn { width: 100%; padding: 0.85rem; font-size: 15px; font-weight: 700; background: var(--accent); color: #fff; border: none; border-radius: 4px; cursor: pointer; letter-spacing: 0.02em; transition: opacity 0.15s; }
    #scoreBtn:hover:not(:disabled) { opacity: 0.88; }
    #scoreBtn:disabled { opacity: 0.45; cursor: not-allowed; }
    .dots::after { content: ''; animation: dots 1.2s steps(4, end) infinite; }
    @keyframes dots { 0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; } }
    .error-box { background: #fff0f0; border: 1px solid #f5c6c6; border-radius: 4px; padding: 0.75rem 1rem; font-size: 13px; color: #b33030; margin-top: 0.75rem; }
    #resultsSection { display: none; margin-top: 2rem; }
    #resultsSection.visible { display: block; }
    .results-eyebrow { margin-bottom: 1rem; }
    .total-score { font-size: 3rem; font-weight: 700; color: var(--accent); line-height: 1; margin-bottom: 0.2rem; }
    .total-label { font-size: 13px; color: var(--fg-muted); margin-bottom: 1.25rem; }
    .narrative { font-size: 15px; color: var(--fg); margin-bottom: 1.5rem; padding: 1rem; background: var(--accent-light); border-radius: 4px; border-left: 3px solid var(--accent); }
    .criterion-card { border: 1px solid var(--border); border-radius: 4px; padding: 1rem; margin-bottom: 0.6rem; }
    .criterion-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem; }
    .criterion-name { font-size: 14px; font-weight: 600; color: var(--fg); }
    .criterion-score { font-size: 14px; font-weight: 700; color: var(--accent); }
    .criterion-bar { height: 4px; background: var(--border); border-radius: 2px; margin-bottom: 0.5rem; }
    .criterion-bar-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.6s ease; width: 0%; }
    .criterion-justification { font-size: 13px; color: var(--fg-muted); line-height: 1.5; }
    .strengths-concerns { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
    @media (max-width: 500px) { .strengths-concerns { grid-template-columns: 1fr; } }
    .sc-block h4 { font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.5rem; }
    .sc-block.strengths h4 { color: var(--accent); }
    .sc-block.concerns h4 { color: #8b4513; }
    .sc-block ul { margin: 0; padding-left: 1.2rem; }
    .sc-block li { font-size: 13px; color: var(--fg-muted); margin-bottom: 0.25rem; }
    .verdict-box { border: 2px solid var(--accent); border-radius: 4px; padding: 0.75rem 1rem; font-weight: 700; font-size: 15px; color: var(--accent); text-align: center; margin-bottom: 1.25rem; }
    .verdict-box.warn { border-color: #d4860a; color: #d4860a; }
    .verdict-box.bad { border-color: #b33030; color: #b33030; }
    #copyBtn { font-size: 13px; padding: 0.5rem 1.25rem; border: 1px solid var(--border); border-radius: 4px; background: #fff; color: var(--fg-muted); cursor: pointer; }
    #copyBtn:hover { border-color: var(--accent); color: var(--accent); }
    footer { margin-top: 3rem; padding: 1.5rem 0; border-top: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 12px; color: var(--fg-muted); flex-wrap: wrap; gap: 0.5rem; }
    footer a { color: var(--fg-muted); text-decoration: none; }
    footer a:hover { color: var(--accent); }
    .hero-sub { font-size: 15px; color: var(--fg-muted); margin-bottom: 0.4rem; }
    .rubric-defense { opacity: 0.6; font-style: italic; }
    .rubric-total td { font-weight: 600; border-top: 2px solid var(--border); }
    .badge-human {
      font-size: 10px; font-weight: 600; letter-spacing: 0.08em;
      text-transform: uppercase; background: #fef9e7; color: #a0720a;
      padding: 0.15rem 0.4rem; border-radius: 3px; margin-left: 0.4rem;
      font-style: normal; vertical-align: middle;
    }
    .section-eyebrow { font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--accent); margin-bottom: 0.2rem; }
    .section-sub { font-size: 12px; color: var(--fg-muted); margin-bottom: 0.5rem; }
    .mandatory-section { margin-top: 1.5rem; }
    .mandatory-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.75rem; }
    .mandatory-item { display: flex; align-items: center; gap: 0.5rem; font-size: 13px; padding: 0.5rem 0.75rem; border-radius: 4px; border: 1px solid var(--border); }
    .elem-present { background: var(--accent-light); }
    .elem-missing { background: #fef2f2; border-color: #fca5a5; }
    .elem-unclear { background: #fef9e7; border-color: #fcd34d; }
    .elem-status { font-weight: 700; font-size: 14px; }
    .elem-present .elem-status { color: var(--accent); }
    .elem-missing .elem-status { color: #dc2626; }
    .elem-unclear .elem-status { color: #a0720a; }
    @media (max-width: 480px) { .mandatory-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div class="container">
  <nav>
    <a href="../index.html" class="nav-brand">SAFE</a>
    <a href="https://www.reddit.com/r/LLMPhysics/" target="_blank" class="nav-link">r/LLMPhysics</a>
  </nav>
  <div class="hero">
    <div class="eyebrow">JAC Self-Audit Judge</div>
    <h1>JAC Self-Audit Judge</h1>
    <p class="hero-sub">Paste your draft below for a pre-submission audit against the official Journal Ambitions Contest rubric. Scores out of 85 — Defense (15 pts) is reserved for human judges.</p>
    <p class="note">Scoring uses your AI provider from SAFE account, or enter a key below.</p>
  </div>
  <div class="api-section" id="apiSection">
    <div id="apiChip" style="display:none;">
      <span class="api-chip">
        <svg width="10" height="10" viewBox="0 0 10 10" fill="currentColor"><circle cx="5" cy="5" r="5"/></svg>
        Using <strong id="chipProvider"></strong> from your SAFE account
        <a onclick="showApiForm()">Change</a>
      </span>
    </div>
    <div id="apiForm">
      <div class="section-label" style="margin-bottom:0.5rem;">API Key</div>
      <div class="api-form">
        <select id="providerSelect">
          <option value="gemini">Gemini (Google)</option>
          <option value="groq">Groq</option>
          <option value="openai">OpenAI</option>
        </select>
        <input type="password" id="apiKeyInput" placeholder="Paste API key..." style="flex:1;min-width:180px;">
        <button class="btn-sm" onclick="saveApiKey()">Save</button>
      </div>
    </div>
  </div>
  <div style="margin-bottom:1rem;">
    <div class="section-label">Paper</div>
    <textarea id="paperInput" placeholder="Paste the full paper text here..."></textarea>
    <div class="char-count"><span id="charCount">0</span> characters</div>
    <div class="url-row">
      <label>Or load from:</label>
      <input type="text" id="urlInput" placeholder="https://arxiv.org/abs/..." oninput="onUrlInput()">
      <button class="url-fetch-btn" id="urlFetchBtn" onclick="fetchFromUrl()" disabled>Fetch</button>
      <span class="divider">or</span>
      <label class="url-browse-btn" for="fileInput">Browse&hellip;</label>
      <input type="file" id="fileInput" accept=".pdf,.txt,.md" style="display:none" onchange="loadFile(this)">
      <span class="url-status" id="urlStatus"></span>
    </div>
  </div>
  <button class="rubric-toggle" onclick="toggleRubric()" id="rubricToggleBtn">
    <span>View rubric</span>
    <span id="rubricArrow">&#9660;</span>
  </button>
  <div id="rubricBody">
    <table class="rubric-table">
      <thead>
        <tr><th>Criterion</th><th>Points</th><th>What judges look for</th></tr>
      </thead>
      <tbody>
        <tr><td>Hypothesis</td><td>15</td><td>Intent and problem clearly stated in abstract or introduction</td></tr>
        <tr><td>Novelty</td><td>15</td><td>Genuinely novel approach &mdash; new derivation path, synthesis, or unexplored angle</td></tr>
        <tr><td>Scientific Humility</td><td>15</td><td>Failure conditions stated; proposal is falsifiable; uncertainty acknowledged</td></tr>
        <tr><td>Engagement</td><td>20</td><td>True engagement with literature &mdash; reasons through it, not just binary agreement/dismissal</td></tr>
        <tr><td>Rigor</td><td>10</td><td>First principles derivations; units preserved; parameters justified</td></tr>
        <tr><td>Citations</td><td>10</td><td>Relevant, verifiable, post-2015 preferred; no hallucinated sources</td></tr>
        <tr class="rubric-defense"><td>Defense <span class="badge-human">human judges only</span></td><td>15</td><td>Response to critique demonstrates understanding. Skipped if no valid critiques raised.</td></tr>
        <tr class="rubric-total"><td><strong>Self-audit total</strong></td><td><strong>85</strong></td><td>Defense scored separately by human judges</td></tr>
      </tbody>
    </table>
  </div>
  <div class="score-wrap">
    <button id="scoreBtn" disabled onclick="scorePaper()">Score This Paper</button>
    <div id="errorBox" class="error-box" style="display:none;"></div>
  </div>
  <div id="resultsSection">
    <div class="results-eyebrow eyebrow">Evaluation Results</div>
    <div class="total-score" id="totalScore">&#8212;</div>
    <div class="total-label">out of 85 (self-audit)</div>
    <div class="narrative" id="narrativeText"></div>
    <div id="criterionCards"></div>
    <div class="strengths-concerns">
      <div class="sc-block strengths"><h4>Strengths</h4><ul id="strengthsList"></ul></div>
      <div class="sc-block concerns"><h4>Top Improvements</h4><ul id="concernsList"></ul></div>
    </div>
    <div class="verdict-box" id="verdictBox"></div>
    <button id="copyBtn" onclick="copyResults()">Copy Results</button>
  </div>
  <footer>
    <span>SAFE &middot; Session-Authorized, Fully Explicit</span>
    <span>
      <a href="https://www.reddit.com/r/LLMPhysics/" target="_blank">r/LLMPhysics</a>
      &nbsp;&middot;&nbsp;<a href="#">About</a>
      &nbsp;&middot;&nbsp;<a href="#">Rules</a>
    </span>
  </footer>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
</script>
<script>
  const STORAGE_KEY = 'safe_account';
  const RUBRIC = [
    { name: 'Hypothesis', max: 15, key: 'hypothesis',
      desc: 'Author clearly states the intent of the paper and the problem it attempts to solve' },
    { name: 'Novelty', max: 15, key: 'novelty',
      desc: 'Author develops a genuinely novel approach to the problem and explores it in new ways' },
    { name: 'Scientific Humility', max: 15, key: 'scientific_humility',
      desc: 'Author presents failure conditions and falsifiability honestly' },
    { name: 'Engagement', max: 20, key: 'engagement',
      desc: 'Author demonstrates true engagement with existing material beyond suggesting binary true and false statements' },
    { name: 'Rigor', max: 10, key: 'rigor',
      desc: 'Values are derived from first principles, units are preserved across equations' },
    { name: 'Citations', max: 10, key: 'citations',
      desc: 'Paper cites references that are both relevant to the material and up to date' },
  ];
  // Defense (15pts) is scored by human judges only — requires author interaction
  // Self-audit total: 85 points
  const SELF_AUDIT_MAX = 85;
  let lastResult = null;

  (function init() {
    const creds = getApiCredentials();
    if (creds) {
      document.getElementById('apiChip').style.display = 'block';
      document.getElementById('apiForm').style.display = 'none';
      document.getElementById('chipProvider').textContent = creds.provider;
    }
    document.getElementById('paperInput').addEventListener('input', onPaperInput);
  })();

  function onPaperInput() {
    const len = document.getElementById('paperInput').value.length;
    document.getElementById('charCount').textContent = len.toLocaleString();
    document.getElementById('scoreBtn').disabled = len < 100;
  }

  function getApiCredentials() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const acct = JSON.parse(raw);
        if (acct.api_key && acct.api_provider) return { provider: acct.api_provider, key: acct.api_key, source: 'safe_account' };
      }
    } catch(e) {}
    const tmpKey = sessionStorage.getItem('temp_llm_key');
    const tmpProvider = sessionStorage.getItem('temp_llm_provider');
    if (tmpKey && tmpProvider) return { provider: tmpProvider, key: tmpKey, source: 'manual' };
    return null;
  }

  function saveApiKey() {
    const provider = document.getElementById('providerSelect').value;
    const key = document.getElementById('apiKeyInput').value.trim();
    if (!key) { alert('Please enter an API key.'); return; }
    sessionStorage.setItem('temp_llm_key', key);
    sessionStorage.setItem('temp_llm_provider', provider);
    document.getElementById('chipProvider').textContent = provider;
    document.getElementById('apiChip').style.display = 'block';
    document.getElementById('apiForm').style.display = 'none';
  }

  function showApiForm() {
    document.getElementById('apiChip').style.display = 'none';
    document.getElementById('apiForm').style.display = 'block';
  }

  function toggleRubric() {
    const body = document.getElementById('rubricBody');
    const arrow = document.getElementById('rubricArrow');
    body.classList.toggle('open');
    arrow.innerHTML = body.classList.contains('open') ? '&#9650;' : '&#9660;';
  }

  function buildJudgePrompt(paperText) {
    return `You are the self-audit judge for the r/LLMPhysics Journal Ambitions Contest (Constitution v0.3).

Score the following manuscript against the official rubric. Return ONLY valid JSON.

RUBRIC (self-audit total: 85 points — Defense requires human interaction and is excluded):
- hypothesis: /15 — Intent and problem clearly stated; vague or absent = low score
- novelty: /15 — Genuinely novel approach; repackaging known results without new angles scores low
- scientific_humility: /15 — Failure conditions stated; proposal is falsifiable; uncertainty acknowledged honestly
- engagement: /20 — True engagement with literature beyond binary true/false; reasons through existing work
- rigor: /10 — First principles derivations; units preserved; parameters explained and justified
- citations: /10 — Relevant, verifiable, post-2015 preferred; flag any that appear hallucinated

MANDATORY ELEMENTS — check each (do not adjust scores, just note status):
1. LLM Disclosure Statement (model used, how used, human oversight process — must be specific)
2. At least 3 modern, verifiable citations
3. Genuine question or problem articulated in abstract/introduction
4. Originality and novelty statement (what's new, how it differs from prior work, acknowledged limitations)

SOFT CONSTRAINTS — note if present or absent:
- Claim type labeling (derived / hypothetical / speculative / literature-based)
- Parameter accounting (parameters justified physically/mathematically)
- Failure conditions and falsifiability statement
- Reproducibility notes (if computational)

Required JSON format:
{
  "scores": {
    "hypothesis": <int 0-15>,
    "novelty": <int 0-15>,
    "scientific_humility": <int 0-15>,
    "engagement": <int 0-20>,
    "rigor": <int 0-10>,
    "citations": <int 0-10>
  },
  "justifications": {
    "hypothesis": "<2-3 sentences — specific, quote/paraphrase the paper>",
    "novelty": "<2-3 sentences>",
    "scientific_humility": "<2-3 sentences>",
    "engagement": "<2-3 sentences>",
    "rigor": "<2-3 sentences>",
    "citations": "<2-3 sentences>"
  },
  "mandatory_elements": {
    "llm_disclosure": "present | missing | unclear",
    "citations_count": "present | missing | unclear",
    "research_question": "present | missing | unclear",
    "novelty_statement": "present | missing | unclear"
  },
  "soft_constraints": {
    "claim_labeling": true | false,
    "parameter_accounting": true | false,
    "failure_conditions": true | false,
    "reproducibility": true | false | "n/a"
  },
  "narrative": "<2-3 sentences: what the paper argues and what it attempts to contribute — neutral and accurate>",
  "strengths": ["<strength 1>", "<strength 2>"],
  "top_improvements": ["<most impactful improvement>", "<second>", "<third>"],
  "verdict": "Ready to submit" | "Needs revision" | "Significant rework needed"
}

Paper to evaluate:
---
${paperText}
---`;
  }

  async function callLLM(prompt, creds) {
    if (creds.provider === 'gemini') {
      const res = await fetch(
        'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + creds.key,
        { method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.2, maxOutputTokens: 2048 } }) }
      );
      if (!res.ok) throw new Error('Gemini API error: ' + res.status);
      const data = await res.json();
      if (data.error) throw new Error('Gemini: ' + data.error.message);
      return data.candidates[0].content.parts[0].text;
    } else if (creds.provider === 'groq') {
      const res = await fetch('https://api.groq.com/openai/v1/chat/completions',
        { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + creds.key },
          body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: [{ role: 'user', content: prompt }], temperature: 0.2, max_tokens: 2048 }) }
      );
      if (!res.ok) throw new Error('Groq API error: ' + res.status);
      const data = await res.json();
      if (data.error) throw new Error('Groq: ' + data.error.message);
      return data.choices[0].message.content;
    } else {
      const res = await fetch('https://api.openai.com/v1/chat/completions',
        { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + creds.key },
          body: JSON.stringify({ model: 'gpt-4o-mini', messages: [{ role: 'user', content: prompt }], temperature: 0.2, max_tokens: 2048 }) }
      );
      const data = await res.json();
      if (!res.ok) {
        const msg = data?.error?.message || 'HTTP ' + res.status;
        if (res.status === 429) throw new Error('OpenAI 429: ' + msg + ' — Check that your account has billing set up and credits available at platform.openai.com/account/billing');
        throw new Error('OpenAI error: ' + msg);
      }
      if (data.error) throw new Error('OpenAI: ' + data.error.message);
      return data.choices[0].message.content;
    }
  }

  function setLoading(on) {
    const btn = document.getElementById('scoreBtn');
    if (on) {
      btn.disabled = true;
      btn.innerHTML = 'Judging<span class="dots"></span>';
    } else {
      btn.innerHTML = 'Score This Paper';
      btn.disabled = document.getElementById('paperInput').value.length < 100;
    }
  }

  function showError(msg) { const b = document.getElementById('errorBox'); b.textContent = msg; b.style.display = 'block'; }
  function hideError() { document.getElementById('errorBox').style.display = 'none'; }

  async function scorePaper() {
    hideError();
    const paperText = document.getElementById('paperInput').value.trim();
    if (paperText.length < 100) return;
    const creds = getApiCredentials();
    if (!creds) { showApiForm(); showError('Please enter an API key to score papers.'); return; }
    setLoading(true);
    try {
      const prompt = buildJudgePrompt(paperText);
      const raw = await callLLM(prompt, creds);
      const jsonMatch = raw.match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error('Model did not return valid JSON. Try again.');
      const result = JSON.parse(jsonMatch[0]);
      lastResult = result;
      renderResults(result);
    } catch(e) {
      showError('Error: ' + e.message);
    } finally {
      setLoading(false);
    }
  }

  function renderResults(result) {
    const scores = result.scores || {};
    const justs = result.justifications || {};
    let total = 0;
    RUBRIC.forEach(r => { total += (scores[r.key] || 0); });
    document.getElementById('totalScore').textContent = total;
    document.getElementById('narrativeText').textContent = result.narrative || '';
    const cards = document.getElementById('criterionCards');
    cards.innerHTML = '';
    RUBRIC.forEach(r => {
      const score = scores[r.key] || 0;
      const pct = Math.round((score / r.max) * 100);
      const card = document.createElement('div');
      card.className = 'criterion-card';
      card.innerHTML = '<div class="criterion-header"><span class="criterion-name">' + r.name + '</span>'
        + '<span class="criterion-score">' + score + ' / ' + r.max + '</span></div>'
        + '<div class="criterion-bar"><div class="criterion-bar-fill" style="width:0%" data-pct="' + pct + '"></div></div>'
        + '<div class="criterion-justification">' + (justs[r.key] || '') + '</div>';
      cards.appendChild(card);
    });
    requestAnimationFrame(() => {
      cards.querySelectorAll('.criterion-bar-fill').forEach(el => { el.style.width = el.dataset.pct + '%'; });
    });
    // Mandatory elements section
    if (result.mandatory_elements) {
      const labels = {
        llm_disclosure: 'LLM Disclosure Statement',
        citations_count: '3+ Modern Citations',
        research_question: 'Research Question Stated',
        novelty_statement: 'Originality & Novelty Statement'
      };
      const mandatoryHtml = '<div class="mandatory-section">'
        + '<div class="section-eyebrow">MANDATORY ELEMENTS</div>'
        + '<div class="section-sub">Required for contest eligibility</div>'
        + '<div class="mandatory-grid">'
        + Object.entries(result.mandatory_elements).map(function([key, val]) {
            const cls = val === 'present' ? 'elem-present' : val === 'missing' ? 'elem-missing' : 'elem-unclear';
            const icon = val === 'present' ? '\u2713' : val === 'missing' ? '\u2717' : '?';
            return '<div class="mandatory-item ' + cls + '">'
              + '<span class="elem-status">' + icon + '</span>'
              + '<span>' + (labels[key] || key) + '</span>'
              + '</div>';
          }).join('')
        + '</div></div>';
      const mandDiv = document.createElement('div');
      mandDiv.innerHTML = mandatoryHtml;
      cards.appendChild(mandDiv);
    }
    const sl = document.getElementById('strengthsList');
    const cl = document.getElementById('concernsList');
    sl.innerHTML = ''; cl.innerHTML = '';
    (result.strengths || []).forEach(s => { const li = document.createElement('li'); li.textContent = s; sl.appendChild(li); });
    (result.top_improvements || result.concerns || []).forEach(c => { const li = document.createElement('li'); li.textContent = c; cl.appendChild(li); });
    const vb = document.getElementById('verdictBox');
    vb.textContent = result.verdict || '';
    vb.className = 'verdict-box';
    if (result.verdict === 'Needs revision') vb.classList.add('warn');
    if (result.verdict === 'Significant rework needed') vb.classList.add('bad');
    const section = document.getElementById('resultsSection');
    section.classList.add('visible');
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function populatePaper(text, label) {
    const status = document.getElementById('urlStatus');
    document.getElementById('paperInput').value = text;
    document.getElementById('charCount').textContent = text.length.toLocaleString();
    document.getElementById('scoreBtn').disabled = text.length < 100;
    status.textContent = '\u2713 Loaded ' + (label || '') + ' \u2014 ' + text.length.toLocaleString() + ' chars';
    status.style.color = 'var(--accent)';
  }

  async function extractPdfText(file) {
    if (typeof pdfjsLib === 'undefined') throw new Error('PDF.js not loaded. Try refreshing the page.');
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    const pages = [];
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      pages.push(content.items.map(item => item.str).join(' '));
    }
    return pages.join('\n\n');
  }

  async function loadFile(input) {
    const file = input.files[0];
    if (!file) return;
    const status = document.getElementById('urlStatus');
    status.textContent = 'Reading ' + file.name + '\u2026';
    status.style.color = 'var(--fg-muted)';
    try {
      let text;
      if (file.name.endsWith('.pdf') || file.type === 'application/pdf') {
        text = await extractPdfText(file);
      } else {
        text = await file.text();
      }
      if (text.trim().length < 50) throw new Error('File appears empty or could not be read.');
      populatePaper(text, file.name);
    } catch(e) {
      status.textContent = e.message;
      status.style.color = '#b33030';
    }
    input.value = '';
  }

  function onUrlInput() {
    const url = document.getElementById('urlInput').value.trim();
    document.getElementById('urlFetchBtn').disabled = !url.startsWith('http');
    document.getElementById('urlStatus').textContent = '';
  }

  async function fetchFromUrl() {
    const url = document.getElementById('urlInput').value.trim();
    if (!url) return;
    const btn = document.getElementById('urlFetchBtn');
    const status = document.getElementById('urlStatus');
    btn.disabled = true;
    btn.textContent = 'Fetching\u2026';
    status.textContent = '';
    status.style.color = 'var(--fg-muted)';
    try {
      // JINA reader: converts any public URL to clean plain text, no CORS issues
      const res = await fetch('https://r.jina.ai/' + url, { headers: { 'Accept': 'text/plain' } });
      if (!res.ok) throw new Error('Could not fetch page (HTTP ' + res.status + ')');
      const text = await res.text();
      if (text.length < 200) throw new Error('Page returned too little content \u2014 try using Browse to upload the PDF directly.');
      populatePaper(text, url.split('/').pop() || url);
    } catch(e) {
      status.textContent = e.message;
      status.style.color = '#b33030';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Fetch';
    }
  }

  function copyResults() {
    if (!lastResult) return;
    const scores = lastResult.scores || {};
    const justs = lastResult.justifications || {};
    let total = 0;
    RUBRIC.forEach(r => { total += (scores[r.key] || 0); });
    const lines = ['r/LLMPhysics Competition \u2014 Paper Evaluation', 'Score: ' + total + '/85 (self-audit)', ''];
    RUBRIC.forEach(r => { lines.push(r.name + ': ' + (scores[r.key] || 0) + '/' + r.max); if (justs[r.key]) lines.push('  ' + justs[r.key]); });
    lines.push('', 'Summary: ' + (lastResult.narrative || ''), '', 'Strengths:');
    (lastResult.strengths || []).forEach(s => lines.push('\u2022 ' + s));
    lines.push('', 'Top Improvements:');
    (lastResult.top_improvements || lastResult.concerns || []).forEach(c => lines.push('\u2022 ' + c));
    lines.push('', 'Verdict: ' + (lastResult.verdict || ''), '', 'Scored by r/LLMPhysics AI Judge (safe-app-llmphysics)');
    navigator.clipboard.writeText(lines.join('\n')).then(() => {
      const btn = document.getElementById('copyBtn');
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = 'Copy Results'; }, 2000);
    }).catch(() => { alert(lines.join('\n')); });
  }
</script>
</body>
</html>